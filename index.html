<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Portfolio HUB</title>
<script src="https://unpkg.com/kaboom/dist/kaboom.js"></script>
</head>
<body>
<script>
// --- Kaboom init ---
kaboom({
  width: window.innerWidth,
  height: window.innerHeight,
  background: [20,20,40],
});

// --- Sprites principales ---
loadSprite("hero", "https://raw.githubusercontent.com/jijoxP/portfolioV1/refs/heads/main/assets/hero.png", {
  sliceX: 10,
  anims: {
    idle: { from: 0, to: 1, speed: 3, loop: true },
    walk: { from: 2, to: 5, speed: 10, loop: true },
    walk2: { from: 6, to: 9, speed: 10, loop: true }
  }
});
loadSprite("portfolioSprite", "https://raw.githubusercontent.com/jijoxP/portfolioV1/refs/heads/main/assets/portfolio%20spriteFerm%C3%A9.png");
loadSprite("bullet", "https://raw.githubusercontent.com/jijoxP/portfolioV1/refs/heads/main/assets/All_Fire_Bullet_Pixel_16x16_07.png");

// --- Charger JSON séparé ---
fetch("config.json") 
  .then(res => res.json())
  .then(config => {

    setGravity(2000);
    const WALK_SPEED = 200, RUN_SPEED = 400;

    scene("main", () => {

      // --- Joueur ---
      const player = add([
        sprite("hero"),
        pos(config.player.startX, config.player.startY),
        scale(config.player.scale),
        area(),
        body()
      ]);
      player.play("idle");

      // --- Sol collé au bas ---
      const groundHeight = 48;
      add([
        rect(2000, groundHeight),
        pos(0, height() - groundHeight),
        color(100,100,200),
        area(),
        body({ isStatic:true }),
        z(0)
      ]);

      // --- Plateformes ---
      config.platforms.forEach(p => {
        add([
          rect(p.w, p.h),
          pos(p.x, p.y),
          color(...p.color),
          area(),
          body({ isStatic: p.static }),
          z(1) // au-dessus du sol/fond
        ]);
      });

      // --- Obstacles ---
      if(config.obstacles){
        config.obstacles.forEach(obs=>{
          const obj = add([
            rect(obs.w, obs.h),
            pos(obs.x, obs.y),
            color(...obs.color),
            area(),
            body({ isStatic:true }),
            z(2)
          ]);
          if(obs.moving){
            let dir = 1;
            obj.onUpdate(()=>{
              obj.move(obs.moving.speed*dir,0);
              if(obj.pos.x>obs.moving.maxX) dir=-1;
              if(obj.pos.x<obs.moving.minX) dir=1;
            });
          }
        });
      }

      // --- Projets ---
      config.projects.forEach(proj=>{
        let obj;
        if(proj.type==="sprite"){
          obj = add([sprite(proj.sprite), pos(proj.x, proj.y), scale(proj.scale), proj.id]);
          loop(1, ()=>{ obj.scale = vec2(proj.scale-0.01, proj.scale-0.01); wait(0.5, ()=>obj.scale=vec2(proj.scale, proj.scale)); });
        }else{
          obj = add([rect(proj.w,proj.h), pos(proj.x,proj.y), color(...proj.color), area(), proj.id]);
        }
        if(proj.moving){
          let dir = 1;
          obj.onUpdate(()=>{ obj.move(proj.moving.speed*dir,0); if(obj.pos.x>proj.moving.maxX) dir=-1; if(obj.pos.x<proj.moving.minX) dir=1; });
        }
        if(proj.id==="project2"){
          onCollide("projectile","project2",b=>{destroy(b); go(proj.openScene);});
        }else{
          player.onCollide(proj.id, ()=>go(proj.openScene));
        }
      });

      // --- Mouvements joueur ---
      let moveDir = 0;
      onKeyDown("left", ()=>moveDir=-1);
      onKeyDown("right", ()=>moveDir=1);
      onKeyRelease("left", ()=>{if(moveDir===-1) moveDir=0;});
      onKeyRelease("right", ()=>{if(moveDir===1) moveDir=0;});
      onKeyPress("space", ()=>{if(player.isGrounded()) player.jump(1000);});

      player.onUpdate(()=>{
        const speed = isKeyDown("shift")?RUN_SPEED:WALK_SPEED;
        player.move(moveDir*speed, 0);
        if(moveDir===1 && player.curAnim()!=="walk") player.play("walk");
        else if(moveDir===-1 && player.curAnim()!=="walk2") player.play("walk2");
        else if(moveDir===0 && player.isGrounded() && player.curAnim()!=="idle") player.play("idle");
      });

      // --- Tir projectiles ---
      onKeyPress("up", ()=>{
        const dir = moveDir>=0?1:-1;
        const bullet = add([sprite("bullet"), pos(player.pos.x+dir*20, player.pos.y+10), scale(2), area(), "projectile"]);
        bullet.onUpdate(()=>bullet.move(dir*600,0));
        wait(2, ()=>destroy(bullet));
      });

      // --- Caméra ---
      onUpdate(()=>camPos(player.pos));

    });

    // --- Scènes projets ---
    config.projects.forEach(p=>{
      scene(p.openScene, ()=>{
        add([text(`${p.id} ouvert !`,{size:32}), pos(center()), anchor("center"), color(255,255,0)]);
        onKeyPress("escape", ()=>go("main"));
      });
    });

    go("main");
  });
</script>
</body>
</html>
